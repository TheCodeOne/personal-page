---
import { getCollection } from "astro:content";

const allPosts = await getCollection("blog");
const allTags = allPosts
  .map((tag) => tag.data.tags)
  .filter((tags): tags is string[] => Array.isArray(tags))
  .flat();

// Count tag frequencies
const tagCounts = allTags.reduce(
  (acc, tag) => {
    acc[tag] = (acc[tag] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>
);

// Sort tags by frequency (descending)
const sortedTags = Object.entries(tagCounts)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 20); // Limit to top 20 tags
---

<div class="tag-cloud">
  {
    sortedTags.length > 0 ? (
      sortedTags.map(([tag, count]) => (
        <a href={`/tags/${tag}`} class="tag-item" data-count={count}>
          {tag}
        </a>
      ))
    ) : (
      <p class="text-center text-neutral-500 dark:text-neutral-400">No tags found</p>
    )
  }
</div>

<style>
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 2rem 0;
    margin: 0 auto;
    max-width: 56rem;
  }

  .tag-item {
    display: inline-block;
    border-radius: 9999px;
    padding: 0.25rem 0.5rem;
    background-color: rgb(229 229 229);
    color: rgb(64 64 64);
    cursor: pointer;
    position: relative;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s ease-in-out;
  }

  .tag-item:hover {
    background-color: rgb(212 212 212);
    color: rgb(23 23 23);
    transform: scale(1.05);
    box-shadow:
      0 4px 6px -1px rgb(0 0 0 / 0.1),
      0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  .dark .tag-item {
    background-color: rgb(64 64 64);
    color: rgb(212 212 212);
  }

  .dark .tag-item:hover {
    background-color: rgb(82 82 82);
    color: rgb(255 255 255);
  }

  .tag-item::after {
    content: attr(data-count);
    position: absolute;
    top: -0.5rem;
    right: -0.5rem;
    background-color: rgb(59 130 246);
    color: white;
    font-size: 0.75rem;
    height: 1.25rem;
    width: 1.25rem;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .tag-item:hover::after {
    opacity: 1;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .tag-cloud {
      gap: 0.5rem;
      padding: 1.5rem 0;
    }

    .tag-item {
      padding: 0.2rem 0.4rem;
      font-size: 0.75rem;
    }
  }
</style>
